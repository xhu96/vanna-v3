name: CI

on:
  pull_request:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  PYTHONUNBUFFERED: "1"
  PROTOCOL_BUFFERS_PYTHON_IMPLEMENTATION: python

jobs:
  lint:
    name: Lint (ruff)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
      - name: Install tox
        run: |
          python -m pip install --upgrade pip
          pip install tox
      - name: Ruff format + lint
        run: tox -e ruff

  typecheck:
    name: Type check (mypy)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
      - name: Install tox
        run: |
          python -m pip install --upgrade pip
          pip install tox
      - name: Mypy
        run: tox -e mypy

  tests:
    name: Unit tests (pytest)
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12"]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"
      - name: Install test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e '.[test]'
      - name: Run tests (offline-safe)
        run: |
          pytest -q \
            -m "not integration and not openai and not anthropic and not gemini and not azureopenai and not ollama and not postgres and not mysql and not snowflake and not bigquery and not clickhouse and not mssql and not presto and not hive and not slow" \
            --durations=20
      - name: Coverage (3.11 only)
        if: ${{ matrix.python-version == '3.11' }}
        run: |
          pytest -q \
            -m "not integration and not openai and not anthropic and not gemini and not azureopenai and not ollama and not postgres and not mysql and not snowflake and not bigquery and not clickhouse and not mssql and not presto and not hive and not slow" \
            --cov=src/vanna --cov-report=term --cov-report=xml:coverage.xml
      - name: Upload coverage artifact
        if: ${{ matrix.python-version == '3.11' }}
        uses: actions/upload-artifact@v4
        with:
          name: coverage-xml
          path: coverage.xml

  postgres-integration:
    name: Postgres integration
    runs-on: ubuntu-latest
    needs: [lint, typecheck, tests]
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
      - name: Install Postgres test deps
        run: |
          python -m pip install --upgrade pip
          pip install -e '.[postgres,test]'
      - name: Run Postgres integration
        env:
          VANNA_POSTGRES_TEST_DSN: postgresql://postgres:postgres@localhost:5432/postgres
        run: |
          pytest -q tests/integration/test_postgres_v3_pipeline.py

  build:
    name: Build distribution
    runs-on: ubuntu-latest
    needs: [lint, typecheck, tests]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
      - name: Build
        run: |
          python -m pip install --upgrade pip
          pip install build twine
          python -m build
          twine check dist/*
      - name: Upload dist artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/*

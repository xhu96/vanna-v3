name: Provider Integration Tests

on:
  workflow_dispatch:
  schedule:
    # Weekly (Mondays at 03:00 UTC)
    - cron: "0 3 * * 1"

permissions:
  contents: read

env:
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  PYTHONUNBUFFERED: "1"

jobs:
  openai:
    name: OpenAI
    runs-on: ubuntu-latest
    if: ${{ secrets.OPENAI_API_KEY != '' }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
      - name: Install tox
        run: |
          python -m pip install --upgrade pip
          pip install tox
      - name: Run OpenAI tests
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: tox -e py311-openai

  openrouter:
    name: OpenRouter
    runs-on: ubuntu-latest
    if: ${{ secrets.OPENROUTER_API_KEY != '' }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
      - name: Install tox
        run: |
          python -m pip install --upgrade pip
          pip install tox
      - name: Run OpenRouter tests
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          # Recommended: set a model explicitly; falls back to openai/gpt-4o-mini
          OPENROUTER_MODEL: ${{ secrets.OPENROUTER_MODEL }}
          OPENROUTER_HTTP_REFERER: ${{ secrets.OPENROUTER_HTTP_REFERER }}
          OPENROUTER_APP_TITLE: ${{ secrets.OPENROUTER_APP_TITLE }}
        run: tox -e py311-openrouter

  anthropic:
    name: Anthropic
    runs-on: ubuntu-latest
    if: ${{ secrets.ANTHROPIC_API_KEY != '' }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
      - name: Install tox
        run: |
          python -m pip install --upgrade pip
          pip install tox
      - name: Run Anthropic tests
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: tox -e py311-anthropic

  gemini:
    name: Gemini
    runs-on: ubuntu-latest
    if: ${{ secrets.GEMINI_API_KEY != '' || secrets.GOOGLE_API_KEY != '' }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
      - name: Install tox
        run: |
          python -m pip install --upgrade pip
          pip install tox
      - name: Run Gemini tests
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: tox -e py311-gemini

  azureopenai:
    name: Azure OpenAI
    runs-on: ubuntu-latest
    if: ${{ secrets.AZURE_OPENAI_API_KEY != '' && secrets.AZURE_OPENAI_ENDPOINT != '' && secrets.AZURE_OPENAI_MODEL != '' }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
      - name: Install tox
        run: |
          python -m pip install --upgrade pip
          pip install tox
      - name: Run Azure OpenAI tests
        env:
          AZURE_OPENAI_API_KEY: ${{ secrets.AZURE_OPENAI_API_KEY }}
          AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
          AZURE_OPENAI_MODEL: ${{ secrets.AZURE_OPENAI_MODEL }}
          AZURE_OPENAI_API_VERSION: ${{ secrets.AZURE_OPENAI_API_VERSION }}
        run: tox -e py311-azureopenai

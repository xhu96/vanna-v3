# Threat Model — Personalization & Skill Fabric

This document outlines the key security threats for the personalization and skill fabric subsystems, along with mitigations in place.

## 1. Prompt Injection into Skill Generator

|                 |                                                                                                                                                                                                                                                                                                                                                                                    |
| --------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Threat**      | Attacker crafts a malicious `description` input that causes the LLM to generate a skill spec with elevated privileges, bypassed policies, or hidden intents                                                                                                                                                                                                                        |
| **Impact**      | A dangerous skill draft could be created                                                                                                                                                                                                                                                                                                                                           |
| **Mitigations** | • Generator output is always set to `draft` environment — it cannot auto-publish<br>• All generated specs are validated by the deterministic **SkillCompiler** (no LLM in compiler path)<br>• Compiler rejects write SQL, missing tenant predicates, unknown tools<br>• Promotion requires passing eval suite + RBAC-gated approval<br>• Audit log records all generation requests |

## 2. Data Exfiltration via Skills

|                 |                                                                                                                                                                                                                                                                                                                                                                                                                         |
| --------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Threat**      | A skill spec is designed to extract data from unauthorized tables or exfiltrate via tool routing hints                                                                                                                                                                                                                                                                                                                  |
| **Impact**      | Unauthorized data access                                                                                                                                                                                                                                                                                                                                                                                                |
| **Mitigations** | • Skills can only ADD policy constraints, never remove them<br>• `required_filters` enforces tenant isolation predicates<br>• `tool_allowlist/denylist` scopes accessible tools<br>• SQL limits enforce `read_only`, `max_rows`, `LIMIT` requirement, and DDL/DML ban<br>• Skills cannot elevate access beyond user's effective `group_memberships`<br>• Row/column redaction rules provide fine-grained access control |

## 3. Unauthorized Skill Promotion

|                 |                                                                                                                                                                                                                                                                                                                                                                                  |
| --------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Threat**      | Non-admin user promotes a skill from draft directly to production                                                                                                                                                                                                                                                                                                                |
| **Impact**      | Untested or malicious skill enters production pipeline                                                                                                                                                                                                                                                                                                                           |
| **Mitigations** | • Ordered state machine enforces sequential promotion: `draft → tested → approved → default`<br>• Promotion beyond draft requires membership in `allow_skill_publish_roles` (default: `admin`)<br>• Promotion to `approved` or `default` requires eval suite passing thresholds<br>• All state transitions are audit-logged with actor, timestamp, and source/target environment |

## 4. Privacy Risks of User Preference Storage

|                 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| --------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Threat**      | Sensitive personal information (PII) is stored in user profiles or glossary entries                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| **Impact**      | Data breach exposure, GDPR/CCPA compliance risk                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **Mitigations** | • **PII redaction** runs on all text before durable storage (emails, phones, SSN-like, API keys, credit cards)<br>• **Explicit opt-in** required: `personalization_enabled` must be True on both tenant and user profiles<br>• **Storage policy checker** rejects raw query results in profiles<br>• **Provenance tracking** records who created/modified each record<br>• User can **export** all stored data (GDPR data portability)<br>• User can **delete** all stored data (GDPR right to erasure)<br>• Session memory is **ephemeral** with configurable TTL (`session_memory_retention_days`)<br>• Profile fields are **explicit** (no free-form blobs) |

## 5. Skill Bypass of Existing Guardrails

|                 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| --------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Threat**      | A skill changes tool permissions or removes existing security guardrails                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **Impact**      | Existing security model is undermined                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| **Mitigations** | • Skills contribute context through the existing `transform_args` pipeline — they cannot modify the pipeline itself<br>• `ToolRegistry._validate_tool_permissions` continues to enforce user `group_memberships`<br>• Skills can only restrict (denylist tools, add required filters) — never expand access<br>• Skill policy constraints are MERGED as union of restrictions when multiple skills apply<br>• Compiled skills are deterministic artifacts — no runtime code execution in the skill path |

## 6. Session Memory Leakage

|                 |                                                                                                                                                                                                                                                  |
| --------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Threat**      | Session memory entries persist beyond intended lifetime                                                                                                                                                                                          |
| **Impact**      | Stale or sensitive context available to future interactions                                                                                                                                                                                      |
| **Mitigations** | • All session memories have explicit `expires_at` timestamp<br>• `SessionMemoryStore.cleanup_expired()` removes expired entries<br>• Configurable retention period via `session_memory_retention_days`<br>• PII redaction applied before storage |
